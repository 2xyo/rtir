%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK

<& '/RTIR/Search/Elements/RefineTabs',
   path => $path,
   Queue => $Queue,
   current_tab => $current_tab, 
   Title => $title,
   Format => $Format,
   Query => $Query,
   Rows => $Rows,
   OrderBy => $OrderBy,
   Order => $Order,
   QueryString => $QueryString,
&>

<& /Elements/ListActions, actions => \@results &>

<form action="<%$RT::WebPath%>/RTIR/Report/BulkReject.html" method="POST">
<input type=hidden name=Status value=<%$Status%>>
<input type=hidden name=BulkReject value="1">

% if( $session{'tickets'}->Count ) {
<a href="BulkReject.html?RTIRCheck=All">[Select All]</a>
<a href="BulkReject.html?RTIRCheck=None">[Unselect All]</a>
% }

<& /RTIR/Search/Elements/ShowResults, 
    Query => $Query,
    QueryString => $QueryString, 
    BaseURL => $BaseURL,
    Format => $Format,
    RTIRCheck => $RTIRCheck,
&>

% if( $session{'tickets'}->Count ) {
<a href="BulkReject.html?RTIRCheck=All">[Select All]</a>
<a href="BulkReject.html?RTIRCheck=None">[Unselect All]</a>
<& /Elements/Submit, Name => "SubmitTicket", Caption => $SubmitCaption, Label => loc("Reject") &>
% }

</form>

<%INIT>
$Format         ||= $RT::RTIRSearchResultFormats->{'RejectReports'};
my $title         = loc("Reject Incident Reports");
my $SubmitCaption = loc("Reject selected incident reports");

$m->comp( '/RTIR/Elements/Header',
           Title   => $title,
           Refresh => $session{'tickets_refresh_interval'},
        );

my ( @results );

if ( $ARGS{'BulkReject'} ) {
    my @tempresults;

    #Iterate through each ticket we've been handed
    while ( my $t = $session{'tickets'}->Next ) {
        $m->out('<!--  Processing <%$t->id%> -->');
        $m->flush_buffer;
        next unless ( $ARGS{ "UpdateTicket". $t->Id } );

        unless( $t->FirstCustomFieldValue('_RTIR_State') eq 'new' ) {
            push @tempresults, [ $t->id, loc("Only new reports may be rejected.") ];
            next;
        }

        # If we don't own the thing we're linking to, change the owner
        if (   $t->OwnerObj->id != $session{'CurrentUser'}->id
            && $t->OwnerObj->id != $RT::Nobody->id )
        {
            push @tempresults, [ 
                $t->id, 
                loc("You may not reject tickets that belong to another user.") 
            ];
            next;
        }

        if ( $t->OwnerObj->id != $session{'CurrentUser'}->id &&
             $t->OwnerObj->id == $RT::Nobody->id ) {
            my $action = $ARGS{'Action'} = 'Take';
            push @tempresults, [ $t->id, loc("Action: ") . $ARGS{'Action'} ];
            my ( $res, $msg ) = $t->$action();
            push( @tempresults, $msg );
        }

        my $oldstate = $t->FirstCustomFieldValue('_RTIR_State');
        
        push @tempresults,
             map { [ $t->id, $_ ] }
             ProcessTicketBasics( ARGSRef => \%ARGS, TicketObj => $t );

        my $newstate = $t->FirstCustomFieldValue('_RTIR_State');
        if ( $newstate ne $oldstate ) {
            push @tempresults,
                 [ $t->id, loc("State changed from [_1] to [_2]", $oldstate, $newstate ) ];
        }
    }
    push @results, map { loc( "Ticket [_1]: [_2]", $_->[0], $_->[1] ) }
                   @tempresults;
    # force redo search if we changed state
    $session{'tickets'}->RedoSearch;
}


# FIXME: Doesn't work as expected with refined search.
# also is not clear should it use Query from
# /RTIR/Search/Results.html?Queue=Incident%20Reports or 
# own? and can it be refined at all?
if ( !$Query ) {
    # We can only reject new tickets, so set the states.
    $Query = $m->comp(
        '/RTIR/Elements/NewQuery',
        Queue => $Queue,
        states => ['new'],
    );
}

my $QueryString = $m->comp(
    '/Elements/QueryString',
    Query   => $Query,
    Format  => $Format,
    Rows    => $Rows,
    OrderBy => $OrderBy,
    Order   => $Order,
    Page    => $Page
);

if ( !$BaseQuery ) {
    $BaseQuery = $m->comp( '/RTIR/Elements/BaseQuery', Queue => $Queue );
}

$Query = "$BaseQuery AND ( $Query )";
my $path = "RTIR/Search/Refine.html?$QueryString&";
$path .= $m->comp( '/Elements/QueryString',
                   ResultPage  => $BaseURL,
                   current_tab => $current_tab,
                   Queue       => $Queue,
                 );

</%INIT>

<%ARGS>
$Status => 'rejected'
$RTIRCheck => 'None'
$Query => undef
$BaseQuery => undef
$Queue => 'Incident Reports'
$Format => undef 
$Rows => 50
$Page => 1
$OrderBy => 'id'
$Order => 'ASC'
$BaseURL => $RT::WebPath . "/RTIR/Report/BulkReject.html?"
$current_tab => 'RTIR/Report/BulkReject.html'
</%ARGS>
