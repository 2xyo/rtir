%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, 
    Title => $title, 
    Refresh => $session{'tickets_refresh_interval'} &>
<& 'Elements/Tabs', 
    current_tab => 'RTIR/Report/BulkReject.html', 
    Title => $title,
    Format => $Format,
    Query => $Query,
    Rows => $Rows,
    OrderBy => $OrderBy,
    Order => $Order,
    QueryString => $QueryString,
&>

<& /RTIR/Elements/ListActions, actions => \@results &>

<form method=get>
<input type=hidden name=Status value=<%$Status%>>
<input type=hidden name=BulkReject value=1>

<& /RTIR/Search/Elements/ShowResults, 
    Queue => $Queue,
    Query => $Query,
    QueryString => $QueryString, 
    BaseURL => $BaseURL,
    %ARGS &>

<a href="BulkReject.html?check=check">[Select All]</a>
<a href="BulkReject.html?check=uncheck">[Unselect All]</a>

<& /Elements/Submit, Name => "SubmitTicket", Caption => $SubmitCaption, Label => loc("Reject") &>
</form>

<%INIT>
$Format = $RT::RTIRRejectSearchResultFormat;
$ARGS{'Format'} = $Format;

my $title = loc("Reject Incident Reports");
my $SubmitCaption = loc("Reject selected incident reports");

my (@tempresults, @results);
if ($ARGS{'BulkReject'}) {
    #Iterate through each ticket we've been handed
    while (my $t = $session{'tickets'}->Next) {
	$RT::Logger->debug( "Checking Ticket ".$t->Id ."\n");
	next unless ($ARGS{"UpdateTicket".$t->Id});
	my $State = $m->scomp("/RTIR/Elements/ShowRTIRField", Ticket => $t, Name => 'State');
	$State =~ s/\s+$//;
	if ($State eq 'new') {
	    # If we don't own the thing we're linking to, change the owner
	    if ($t->OwnerObj->id != $session{'CurrentUser'}->id && 
		$t->OwnerObj->id != $RT::Nobody->id) {
		    @tempresults = loc("You may not reject tickets that belong to another user.");
	    } else {
		@tempresults = ();
		if ($t->OwnerObj->id != $session{'CurrentUser'}->id &&
		    $t->OwnerObj->id == $RT::Nobody->id) {
		    $ARGS{'Action'} = 'Take';
		    my $action = $ARGS{'Action'};
		    push @tempresults, "Action: ".$ARGS{'Action'};
		    my ($res, $msg)=$t->$action();
		    push (@tempresults, $msg);
		}
		my ($oldstate, $newstate);
		$oldstate = $t->FirstCustomFieldValue('_RTIR_State');
		push @tempresults, ProcessTicketBasics(ARGSRef => \%ARGS, TicketObj=>$t);
		$newstate = $t->FirstCustomFieldValue('_RTIR_State');
		if ($newstate ne $oldstate) {
		    push (@tempresults, loc("State changed from [_1] to [_2]", $oldstate, $newstate));
		}
	    }
	} else {
	    push @tempresults, loc("Cannot reject Incident Report #[_1].  Only new reports may be rejected.", $t->id);
	}
	@tempresults = map { loc("Ticket [_1]: [_2]",$t->Id,$_) } @tempresults;
	@results = (@results, @tempresults);
    }
}

my @states = ['new'];
if (!$Query) {
    $Query = $m->comp('/RTIR/Elements/NewQuery', Queue => $Queue, states => @states);
}

my $QueryString = "&".$m->comp('/Elements/QueryString',
                               Query => $Query,
                               Format => $Format,
                               Rows => $Rows,
                               OrderBy => $OrderBy,
                               Order => $Order,
                               Page => $Page);

if (!$BaseQuery) {
    $BaseQuery = $m->comp('/RTIR/Elements/BaseQuery', Queue => $Queue);
}

$Query = "$BaseQuery AND ( $Query )";
$ARGS{'Query'} = $Query;

my $refinetabs = { };

$refinetabs->{'_a'} = {
    class => "nav",
    path => "RTIR/Search/RejectRefine.html?Queue=$Queue$QueryString",
    title => loc('Refine') };
	
</%INIT>

<%ARGS>
$Status => 'rejected'
$check => 'uncheck'
$Query => undef
$BaseQuery => undef
$Queue => 'Incident Reports'
$Format => undef 
$Rows => 50
$Page => 1
$OrderBy => 'id'
$Order => 'ASC'
$BaseURL => "/RTIR/Report/BulkReject.html"
</%ARGS>
