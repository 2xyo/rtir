%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $Title &>
% my $EscapedQueue = $m->comp('/Elements/QueryString', Queue => $Queue );
% if ( $Split ) {
<& '/RTIR/'.$Type.'/Elements/Tabs', 
    Title          => $Title,
    Ticket         => $TicketObj,
    current_tab    => "RTIR/Split.html?Ticket=".$TicketObj->Id,
    current_subtab => "RTIR/Split.html?Ticket=".$TicketObj->Id,
&>
% } elsif ( $Incident ) {
<& "/RTIR/Search/Elements/RefineTabs",
    Title          => $Title,
    Ticket         => $IncidentObj,
    Queue          => $Queue,
    current_tab    => "RTIR/Create.html?Incident=$Incident&$EscapedQueue",
&>
% } else {
<& "/RTIR/".$Type."/Elements/Tabs",
    Title          => $Title,
    Ticket         => $TicketObj,
    current_tab    => "RTIR/Create.html?$EscapedQueue",
    current_subtab => "RTIR/Create.html?$EscapedQueue",
&>
% }

<& /Elements/ListActions, actions => \@results &>

% if ( $Split && !$TicketObj->CurrentUserHasRight('ModifyTicket') ) {
<% loc("You are not allowed to split this [_1].", $name) %>
%    $m->abort();
% }

% unless ( $Split ) {
<form action="<% RT->Config->Get('WebPath') %>/RTIR/Create.html" method="post" enctype="multipart/form-data">
% } else {
<form action="<% RT->Config->Get('WebPath') %>/RTIR/Split.html" method="post" enctype="multipart/form-data">
% }
<input type="hidden" name="id" value="new" />
<input type="hidden" name="Queue" value="<% $Queue %>" />
<input type="hidden" name="Status" value="<% $Status || 'new' %>" />
<input type="hidden" name="Incident" value="<% $Incident || '' %>" />
% if ( $Split ) {
<input type="hidden" name="Ticket" value="<% $TicketObj->Id %>" />
% }
<%PERL>
my $parentvalue;
if ( $IncidentObj ) {
    $parentvalue = $IncidentObj->Id;
} elsif ($TicketObj) {

    # XXX: How do we want to link to the former ticket while split?
    # MemberOf is buggy, for example IR(that was not linked to Inc) while split
    # generate new IR, but linked to itself, this hides the IR from RTIR at glance.
    # also we couldn't see "IR MeberOf IR" links.
    # $parentvalue = $TicketObj->Id; # this string was commented out

    my $incidents = new RT::Tickets( $session{'CurrentUser'} );
    $incidents->FromSQL( "Queue = 'Incidents' AND HasMember = " . $TicketObj->Id );
    while ( my $incident = $incidents->Next ) {
        $parentvalue .= ' ' if $parentvalue;
        $parentvalue .= $incident->Id;
    }
}
</%PERL>
% if ( $parentvalue ) {
<input type="hidden" name="new-MemberOf" value="<% $parentvalue %>" />
% }

<a name="top"></a>

<& /Widgets/TitleBoxStart, contentbg => "#cccccc", title => $Title &>
<table border="0" cellpadding="0" cellspacing="2">
% if ( $Incident ) {
  <tr>
    <td align="right"><&|/l&>Incident</&>:</td>
    <td><% $Incident %></td>
  </tr>
% } elsif ( $parentvalue ) {
  <tr>
    <td align="right"><&|/l&>Split from</&>:</td>
    <td><% $parentvalue %></td>
  </tr>
% }
  <tr>
    <td class="label">
      <&|/l&>Owner</&>:
    </td>
    <td>
      <& /Elements/SelectOwner, 
          Name => "Owner", 
          QueueObj => $QueueObj, 
          Default => $ARGS{Owner}||$session{'CurrentUser'}->Id||undef &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Subject</&>:
    </td>
    <td class="value" colspan="5">
      <input name="Subject" size="60" maxsize="100" value="<% $Subject || ''%>" />
    </td>
  </tr>
  <tr>
      <td align="right"><&|/l&>Time Worked</&>:</td>
    <td colspan="2">
      <table>
      <tr>
        <td><input size="3" name="TimeWorked" value="<% $ARGS{'TimeWorked'} || '' %>" /></td>
        <td align="right"><&|/l&>Time Left</&>:</td>
        <td><input size="3" name="TimeLeft" value="<% $ARGS{'TimeLeft'} || '' %>" /></td>
      </tr>
      </table>
    </td>     
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Correspondents</&>:
    </td>
    <td colspan="5">
      <input name="Requestors" value="<% $ARGS{'Requestors'} || '' %>" size="40" />
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Cc</&>:
    </td>
    <td class="value" colspan="5">
      <input name="Cc" value="<% $ARGS{'Cc'} || '' %>" size="40" />
      <i><font size="-2">
      <&|/l&>(Sends a carbon-copy of this update to a comma-delimited list of email addresses. These people <b>will</b> receive future updates.)</&></font></i>
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Admin Cc</&>:
    </td>
    <td class="value" colspan="5">
      <input name="AdminCc" value="<% $ARGS{'AdminCc'} || '' %>" size="40" />
      <i><font size="-2">
      <&|/l&>(Sends a carbon-copy of this update to a comma-delimited list of administrative email addresses. These people <b>will</b> receive future updates.)</&></font></i>
    </td>
  </tr>

% if ( $Type eq 'Report' ) {
  <tr>
    <td class="labeltop"><&|/l&>SLA</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $QueueObj, 
         Name => 'SLA',
         Default => RT::IR::DefaultSLA() &>
    </td>
  </tr>
  <tr>
    <td class="labeltop"><&|/l&>Customer</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $QueueObj, 
         Name => 'Customer' &>
    </td>
  </tr>
  <tr>
    <td class="labeltop">
      <%loc("How Reported")%>:
    </td>
    <td class="value" colspan="2">
      <table>
        <tr>
          <td>
            <& /RTIR/Elements/EditRTIRField, 
              TicketObj => $TicketObj,
              QueueObj => $QueueObj, 
              Name => 'HowReported',
              Default => $ARGS{'HowReported-Value'} || RT->Config->Get('_RTIR_HowReported_default') &>
          </td>
    <td class="labeltop">
      <%loc("Reporter Type")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
        TicketObj => $TicketObj,
        QueueObj => $QueueObj, 
        Name => 'ReporterType',
        Default => $ARGS{'ReporterType-Value'} || RT->Config->Get('_RTIR_ReporterType_default'), &>
    </td>
        </tr>
      </table>
    </td>
  </tr>
% } elsif ($Type eq "Block") {
  <tr>
    <td class="label">
      <%loc("IP address")%>:
    </td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
        TicketObj => $TicketObj,
        QueueObj => $QueueObj, 
        Name => 'IP',
        Default => $ARGS{'IP-Value'} || RT->Config->Get('_RTIR_IP_default'), &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Netmask")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
        TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'Netmask',
        Default => $ARGS{'Netmask-Value'} || RT->Config->Get('_RTIR_Netmask_default'), &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Port")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
        TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'Port',
        Default => $ARGS{'Port-Value'} || RT->Config->Get('_RTIR_Port_default') &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Where Blocked")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
        TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'WhereBlocked',
        Default => $ARGS{'WhereBlocked-Value'} || RT->Config->Get('_RTIR_WhereBlocked_default'), &>
    </td>
  </tr>
% } elsif ($Type eq "Investigation") {
  <tr>
    <td class="labeltop"><&|/l&>Customer</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $QueueObj, 
         Name => 'Customer' &>
    </td>
  </tr>
% }
  <tr>
    <td colspan="2">
      <& /Ticket/Elements/EditCustomFields, 
        TicketObj => $TicketObj, 
        QueueObj => $QueueObj &>
    </td>
  </tr>

<& SELF:AttachmentsForm &>

<tr>
<td class="labeltop">
<&|/l&>Message</&>:
</td>
<td colspan="5">
% if (!exists $ARGS{Content}) {
%   my $Transactions;
%   if ($TicketObj) {
%     $Transactions = $TicketObj->Transactions;
%   } elsif ($IncidentObj) {
%     $Transactions = $IncidentObj->Transactions;
%   }
%
%   if ($Transactions) {
%   # Investigations should quote their included text
%   my $quote = 0;
%   if ($Type eq 'Investigation') {
%       $quote = 1;
%   }
%   $ARGS{Content} = $m->scomp("/RTIR/Elements/TransactionData", 
%      Transactions => $Transactions,
%      Type => 'messages',
%      Include => {'Create', 'Correspond'},
%      QuoteText => $quote);
%      $ARGS{Content} =~ s/\&gt;/>/g;
%   }
% }
<& /Elements/MessageBox, Default => $ARGS{Content}, QuoteTransaction => $QuoteTransaction &>
  <br />
  </td>
</tr>
<tr>
  <td align="right" colspan="2">
  </td>
</tr>
<tr>
  <td>
  </td>
  <td valign="top">
    <& /Widgets/TitleBoxStart, title => loc("Dates"),
                title_class=> 'inverse',  
                 color => "#663366" &>

    <table border="0">
      <tr>
        <td align="right"><&|/l&>Starts</&>:</td>
          <td><input size="10" name="Starts" value="<% $ARGS{Starts} || '' %>" /></td>
      </tr>
      <tr>
        <td align="right"><&|/l&>Due</&>:</td>
        <td><input size="10" name="Due" value="<% $ARGS{Due} || '' %>" /></td>
      </tr>
    </table>
    <& /Widgets/TitleBoxEnd &>
  </td>
</tr>

</table>
<& /Widgets/TitleBoxEnd &>

% if ($Type eq 'Investigation') {
<& /Elements/Submit, Name => "Create", Label => loc("Launch")&>
% } else {
<& /Elements/Submit, Name => "Create", Label => loc("Create")&>
% }
</form>

<%INIT>
my $QueueObj = new RT::Queue( $session{'CurrentUser'} );
$QueueObj->Load( $Queue ) || Abort( loc("Queue could not be loaded.") );

my ($Type) = $m->comp('/RTIR/Elements/Type', Queue => $Queue );
if ($Type eq 'Block' && RT->Config->Get('RTIR_DisableBlocksQueue') ) {
    Abort(loc("Blocks queue is disabled via config file"));
}
if ( $m->comp_exists("/RTIR/$Type/Create.html") ) {
    return $m->comp( "/RTIR/$Type/Create.html", %ARGS );
}

my $Status;
if ($Queue eq "Incident Reports") {
    $Status = 'new';
} elsif ($Queue eq "Investigations") {
    $Status = 'open';
} elsif ($Queue eq "Blocks") {
    $Status = 'new';
}

my ($Title, $IncidentObj);
my $TicketObj = $ARGS{'TicketObj'};

if ( $Incident ) {
    $IncidentObj = LoadTicket( $Incident );
    $Subject ||= $IncidentObj->Subject;
}


my $name;
if ( $Type eq 'Report' ) {
    $name = 'Incident Report';
} else {
    $name = $Type;
}

if ( $Split ) {
    $Title = loc("Split [_1] #[_2]: [_3]", $name, $TicketObj->id, $TicketObj->Subject);
} else {
    if ( $Type eq 'Investigation' ) {
        $Title = loc("Launch a new [_1]", $name);
    } else {
        $Title = loc("Create a new [_1]", $name);
    }
}

$m->comp( 'SELF:ProcessAttachments', %ARGS );

my @results;
if ( !$ARGS{'AddAttachment'} && $ARGS{'id'} eq 'new' ) {
    if ( $Type ne 'Investigation' || $ARGS{'Requestors'} ) {
        return $m->comp( 'Display.html', %ARGS );
    } else {
        push @results, loc( "Investigation launch failed: You must enter a correspondent.");
    }
}

</%INIT>

<%ARGS>
$Queue => undef
$Incident => undef
$Split => 0
$Subject => undef
$QuoteTransaction => undef
</%ARGS>

<%METHOD ProcessAttachments>
<%ARGS>
@DeleteAttachments => ()
$Attachment => '';
</%ARGS>
<%INIT>

$session{'Attachments'} ||= {};

# deal with deleting uploaded attachments
foreach ( @DeleteAttachments ) {
    next unless exists $session{'Attachments'}{ $_ };
    delete $session{'Attachments'}{ $_ };
    $session{'i'}++;
}

# store the uploaded attachment in session
if ( $Attachment ) {
    my $filename = "$Attachment";
    $filename =~ s{^.*[\\/]}{};

    my $entity = MakeMIMEEntity(
        Subject             => $filename,
        Body                => '',
        AttachmentFieldName => 'Attachment'
    );
    $session{'Attachments'}{ $filename } = $entity;
    $session{'i'}++;
}
</%INIT>
</%METHOD>

<%METHOD AttachmentsForm>

<table>

% if ( exists $session{'Attachments'} && keys %{ $session{'Attachments'} } ) {
<tr><td><&|/l&>Attached file</&>:</td>
<td>
<&|/l&>Check box to delete</&><br />
<ul class="files">
% foreach my $name (keys %{$session{'Attachments'}}) {
<li><input type="checkbox" name="DeleteAttachments" value="<% $name %>" /><% $name %></li>
% }
</ul>
</td></tr>
% }

<tr><td class="label"><&|/l&>Attach file</&>:</td>
<td class="value">
<input type="file" name="Attachment" />
<input type="submit" name="AddAttachment" value="<&|/l&>Add More Files</&>" />
</td></tr>

</table>

</%METHOD>
