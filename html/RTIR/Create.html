%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $Title &>
% my $EscapedQueue = $m->comp('/Elements/QueryString', Queue => $Queue );
% if ( $Split ) {
<& '/RTIR/'.$Type.'/Elements/Tabs', 
    Title          => $Title,
    Ticket         => $TicketObj,
    current_tab    => "RTIR/Split.html?Ticket=".$TicketObj->Id,
    current_subtab => "RTIR/Split.html?Ticket=".$TicketObj->Id,
&>
% } elsif ( $Incident ) {
<& "/RTIR/Incident/Elements/LinkTabs",
    Title          => $Title,
    Ticket         => $IncidentObj,
    Queue          => $Queue,
    current_tab    => "RTIR/Create.html?Incident=$Incident&$EscapedQueue",
    current_subtab => "RTIR/Create.html?Incident=$Incident&$EscapedQueue",
&>
% } else {
<& "/RTIR/".$Type."/Elements/Tabs",
    Title          => $Title,
    Ticket         => $TicketObj,
    current_tab    => "RTIR/Create.html?$EscapedQueue",
    current_subtab => "RTIR/Create.html?$EscapedQueue",
&>
% }

<& /Elements/ListActions, actions => \@results &>

% if ( $Split && !$TicketObj->CurrentUserHasRight('ModifyTicket') ) {
<% loc("You are not allowed to split this [_1].", $name) %>
%    $m->abort();
% }

<form action="<%$RT::WebPath%>/RTIR/Create.html" method="post" enctype="multipart/form-data">
<input type="hidden" name="id" value="new" />
<input type="hidden" name="Queue" value="<% $QueueObj->Name %>" />
<input type="hidden" name="Status" value="<% $Status || 'open' %>" />
<input type="hidden" name="Incident" value="<% $ARGS{Incident} %>" />
% my $parentvalue;
% if ($IncidentObj) {
% $parentvalue = $IncidentObj->Id;
% } elsif ($TicketObj) {
%   $parentvalue = $TicketObj->Id;
%   my $query = "Queue = 'Incidents' AND HasMember = " . $TicketObj->Id;
%   my $incidents = new RT::Tickets($session{'CurrentUser'});
%   $incidents->FromSQL($query);
%   while (my $incident = $incidents->Next) {
%     $parentvalue = $parentvalue." ".$incident->Id;
%   }
% }
% if (defined $parentvalue) {
<input type="hidden" name="new-MemberOf" value="<% $parentvalue %>" />
% }
<a name="top">

<& /Widgets/TitleBoxStart, contentbg => "#cccccc", title => $Title &>
<table border="0" cellpadding="0" cellspacing="2">
% if ($Incident) {
  <tr>
    <td align="right"><&|/l&>Incident</&>:</td>
    <td><% $Incident %></td>
  </tr>
% } elsif (defined $parentvalue) {
  <tr>
    <td align="right"><&|/l&>Split from</&>:</td>
    <td><% $parentvalue %></td>
  </tr>
% }
  <tr>
    <td class="label">
      <&|/l&>Owner</&>:
    </td>
    <td>
      <& /Elements/SelectOwner, 
          Name => "Owner", 
	  QueueObj => $QueueObj, 
	  Default => $ARGS{Owner}||$session{'CurrentUser'}->Id||undef &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Subject</&>:
    </td>
    <td class="value" colspan="5">
      <input name="Subject" size="60" maxsize="100" value="<% $Subject || ''%>" />
    </td>
  </tr>
  <tr>
      <td align="right"><&|/l&>Time Worked</&>:</td>
    <td colspan="2">
      <table>
      <tr>
	<td><input size="3" name="TimeWorked"<% $ARGS{TimeWorked} && " value=\"$ARGS{TimeWorked}\""  %> /></td>
        <td align="right"><&|/l&>Time Left</&>:</td>
	<td><input size="3" name="TimeLeft"<% $ARGS{TimeLeft} && " value=\"$ARGS{TimeLeft}\"" %> /></td>
      </tr>
      </table>
    </td>     
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Correspondents</&>:
    </td>
    <td colspan="5">
      <input name="Requestors" value="<%$ARGS{Requestors}%>" size="40" />
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Cc</&>:
    </td>
    <td class="value" colspan="5">
      <input name="Cc" value="<%($ARGS{Cc})%>" size="40" />
      <i><font size="-2">
      <&|/l&>(Sends a carbon-copy of this update to a comma-delimited list of email addresses. These people <b>will</b> receive future updates.)</&></font></i>
    </td>
  </tr>
  <tr>
    <td class="label">
      <&|/l&>Admin Cc</&>:
    </td>
    <td class="value" colspan="5">
      <input name="AdminCc" value="<%($ARGS{AdminCc}) || ""%>" size="40" />
      <i><font size="-2">
      <&|/l&>(Sends a carbon-copy of this update to a comma-delimited list of administrative email addresses. These people <b>will</b> receive future updates.)</&></font></i>
    </td>
  </tr>

% if ($QueueObj->Name eq 'Incident Reports') {
  <tr>
    <td class="labeltop"><&|/l&>SLA</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $QueueObj, 
	 Name => 'SLA',
	 Default => $sla &>
    </td>
  </tr>
  <tr>
    <td class="labeltop">
      <%loc("How Reported")%>:
    </td>
    <td class="value" colspan="2">
      <table>
        <tr>
          <td>
            <& /RTIR/Elements/EditRTIRField, 
	      TicketObj => $TicketObj,
              QueueObj => $QueueObj, 
	      Name => 'HowReported',
	      Default => $ARGS{'HowReported-Value'} || $RT::_RTIR_HowReported_default &>
          </td>
    <td class="labeltop">
      <%loc("Reporter Type")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
	TicketObj => $TicketObj,
        QueueObj => $QueueObj, 
	Name => 'ReporterType',
	Default => $ARGS{'ReporterType-Value'} || $RT::_RTIR_ReporterType_default, &>
    </td>
        </tr>
      </table>
    </td>
  </tr>
% } elsif ($Type eq "Block") {
  <tr>
    <td class="label">
      <%loc("IP address")%>:
    </td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
	TicketObj => $TicketObj,
        QueueObj => $QueueObj, 
	Name => 'IP',
	Default => $ARGS{'IP-Value'} || $RT::_RTIR_IP_default, &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Netmask")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
	TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'Netmask',
	Default => $ARGS{'Netmask-Value'} || $RT::_RTIR_Netmask_default, &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Port")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
	TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'Port',
	Default => $ARGS{'Port-Value'} || $RT::_RTIR_Netmask_default, &>
    </td>
  </tr>
  <tr>
    <td class="label">
      <%loc("Where Blocked")%>:
    </td>
    <td class="value" colspan="2">
      <& /RTIR/Elements/EditRTIRField, 
	TicketObj => $TicketObj,
        QueueObj => $QueueObj, Name => 'WhereBlocked',
	Default => $ARGS{'WhereBlocked-Value'} || $RT::_RTIR_WhereBlocked_default, &>
    </td>
  </tr>
% }
  <tr>
    <td colspan="2">
      <& /Ticket/Elements/EditCustomFields, 
        TicketObj => $TicketObj, 
	QueueObj => $QueueObj &>
    </td>
  </tr>
<tr>
% if (exists $session{'Attachments'}) {
<td>
<&|/l&>Attached file</&>:
</td>
<td colspan="5">
<&|/l&>Check box to delete</&><br />
% foreach my $attach_name (keys %{$session{'Attachments'}}) {
<input type="checkbox" name="DeleteAttach-<%$attach_name%>" /><%$attach_name%><br />
% } # end of foreach
</td>
</tr>
<tr>
% } # end of if
<td class="label">
<&|/l&>Attach file</&>:
</td>
<td class="value" colspan="5">
<input type="file" name="Attach" />
<input type="submit" name="AddMoreAttach" value="<&|/l&>Add More Files</&>" />
</td>
</tr>
<tr>
<td class="labeltop">
<&|/l&>Message</&>:
</td>
<td colspan="5">
% if (!exists $ARGS{Content}) {
%   my $Transactions;
%   if ($TicketObj) {
%     $Transactions = $TicketObj->Transactions;
%   } elsif ($IncidentObj) {
%     $Transactions = $IncidentObj->Transactions;
%   }
%
%   if ($Transactions) {
%   # Investigations should quote their included text
%   my $quote = 0;
%   if ($Type eq 'Investigation') {
%     $quote = 1;
%   }
%   $ARGS{Content} = $m->scomp("/RTIR/Elements/TransactionData", 
%      Transactions => $Transactions,
%      Type => 'messages',
%      Include => {'Create', 'Correspond'},
%      QuoteText => $quote);
%   $ARGS{Content} =~ s/\&gt;/>/g;
%   }
% }
<& /Elements/MessageBox, Default => $ARGS{Content}, QuoteTransaction => $QuoteTransaction &>
  <br />
  </td>
</tr>
<tr>
  <td align="right" colspan="2">
  </td>
</tr>
<tr>
  <td>
  </td>
  <td valign="top">
    <& /Widgets/TitleBoxStart, title => loc("Dates"),
		title_class=> 'inverse',  
		 color => "#663366" &>

    <table border="0">
      <tr>
        <td align="right"><&|/l&>Starts</&>:</td>
	  <td><input size="10" name="Starts" value="<% $ARGS{Starts} || '' %>" /></td>
      </tr>
      <tr>
        <td align="right"><&|/l&>Due</&>:</td>
	<td><input size="10" name="Due" value="<% $ARGS{Due} || '' %>" /></td>
      </tr>
    </table>
    <& /Widgets/TitleBoxEnd &>
  </td>
</tr>

</table>
<& /Widgets/TitleBoxEnd &>

% if ($Type eq 'Investigation') {
<& /Elements/Submit, Name => "Create", Label => loc("Launch")&>
% } else {
<& /Elements/Submit, Name => "Create", Label => loc("Create")&>
% }
</form>

<%INIT>
my $QueueObj = new RT::Queue($session{'CurrentUser'});
$QueueObj->Load($Queue) || Abort(loc("Queue could not be loaded."));

my ($Type, $Status);
if ($Queue eq "Incidents") {
  $Type = "Incident";
  $Status = 'open';
} elsif ($Queue eq "Incident Reports") {
  $Type = "Report";
  $Status = 'new';
} elsif ($Queue eq "Investigations") {
  $Type = "Investigation";
  $Status = 'open';
} elsif ($Queue eq "Blocks") {
  $Type = "Block";
  $Status = 'new';
}

# Incidents have their own Create.html
if ($Type eq 'Incident') {
  $m->comp("/RTIR/Incident/Create.html", %ARGS);
  $m->abort;
}

my ($Title, $IncidentObj);
my $TicketObj = $ARGS{TicketObj};

if ($Incident) {
  $IncidentObj = new RT::Ticket($session{'CurrentUser'});
  $IncidentObj = LoadTicket($Incident);
}

# if there isn't a subject, but there is an incident, use that one
if ((!$Subject) and $IncidentObj) {
  $Subject = $IncidentObj->Subject;
}

my $name;
if ($Type eq 'Report') {
    $name = "Incident Report";
} else {
    $name = $Type;
}

if ($Split) {
    $Title = loc("Split [_1] #[_2]: [_3]", $name, $TicketObj->id, $TicketObj->Subject);
} else {
    if ($Type eq 'Investigation') {
        $Title = loc("Launch a new [_1]", $name);
    } else {
        $Title = loc("Create a new [_1]", $name);
    }
}

# {{{ deal with deleting uploaded attachments
foreach my $key (keys %ARGS) {
    if ($key =~ m/^DeleteAttach-(.+)$/) {
    	delete $session{'Attachments'}{$1};
    }
    $session{'Attachments'} = { %{$session{'Attachments'} || {}} };
}

# {{{ store the uploaded attachment in session
if ($ARGS{'Attach'}) {			# attachment?
    $session{'Attachments'} = {} unless defined $session{'Attachments'};

    # strip leading directories
    $ARGS{'Attach'} =~ s#^.*[\\/]##;

    my $attachment = MakeMIMEEntity(
        Subject             => "$ARGS{'Attach'}",
        Body                => "",
        AttachmentFieldName => 'Attach'
    );
    $session{'Attachments'} = { %{$session{'Attachments'} || {}},
				$ARGS{'Attach'} => $attachment };
}
# }}}

# delete temporary storage entry to make WebUI clean
unless (keys %{$session{'Attachments'}} and $ARGS{'id'} eq 'new') {
    delete $session{'Attachments'};
}


# }}}

my @results;
if ((!exists $ARGS{'AddMoreAttach'}) && ($ARGS{'id'} eq 'new')) { # new ticket?
  if ($Type ne 'Investigation' ||
      ($Type eq 'Investigation' &&  $ARGS{'Requestors'})) {
    $m->comp('Display.html', %ARGS);
    $m->abort();
  } else {
    push @results, loc( "Investigation launch failed: You must enter a correspondent.");
  }
}

my $sla;
if ($Queue eq 'Incident Reports') {
    $sla = RT::IR::DefaultSLA();
}

</%INIT>

<%ARGS>
$Queue => undef
$Incident => undef
$Split => 0
$Subject => undef
$QuoteTransaction => undef
</%ARGS>

