%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => loc($Title) &>
<& /RTIR/Elements/Tabs, Title => loc($Title) &>

<& /RTIR/Elements/ListActions, actions => \@results &>

<FORM METHOD=POST>
<TABLE WIDTH=100% border=0 cellpadding=3 CELLSPACING=0>
<TR>
<TH><&|/l&>Update</&></TH>
%foreach my $col (@cols) {
% my $colalias = $col;
% $colalias =~ s/(Obj\-\>|)(Name|AsString)//;

<TH><% loc($colalias) %>&nbsp;</TH>
%}
</TR>

<%PERL>

my $i;


      
$session{'tickets'}->RedoSearch();
while (my $Ticket = $session{'tickets'}->Next) {
 $i++;
 if ($i % 2) {
     $bgcolor = "#dddddd";
 }
 else {
     $bgcolor = "#ffffff";
 }
      </%PERL>
<TR bgcolor="<%$bgcolor%>">
<TD><input type=checkbox name="UpdateTicket<%$Ticket->Id%>" CHECKED></TD>
%# The ticket view is controlled by config.pm, WebOptions
%foreach my $col (@cols) {
<TD>
% if ($col eq 'id') {
<A HREF="<% $RT::WebPath%>/RTIR/Display.html?id=<%$Ticket->Id%>"><%$Ticket->Id()%></A>
% } elsif ($col eq 'State') {
<& "/RTIR/Elements/ShowRTIRField", Ticket => $Ticket, Name => 'State' &>
% }
%else {
<% eval "\$Ticket->$col()" %>&nbsp;
%}
</TD>
%}
</TR>
%}



</TABLE>

<HR>


<& /Elements/TitleBoxStart, title => loc('Update selected '.$TypeString) &>
<TABLE>
<TR>
<TD VALIGN=TOP>
<table>
<tr><td class=label> <&|/l&>Make Owner</&>: </td>
<td class=value> <& /Elements/SelectOwner, Name => "Owner" &> (<input type=checkbox name="ForceOwnerChange"> <&|/l&>Force change</&>) </td></tr>
% if ($Type ne 'Incident') {
<tr><td class=label> <&|/l&>Add Correspondent</&>: </td>
<td class=value> <INPUT Name="AddRequestor" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove Correspondent</&>: </td>
<td class=value> <INPUT Name="DeleteRequestor" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Add Cc</&>: </td>
<td class=value> <INPUT Name="AddCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove Cc</&>: </td>
<td class=value> <INPUT Name="DeleteCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Add AdminCc</&>: </td>
<td class=value> <INPUT Name="AddAdminCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove AdminCc</&>: </td>
<td class=value> <INPUT Name="DeleteAdminCc" SIZE=20> </td></tr>
% } else {
  <tr>
    <td class=labeltop><&|/l&>Make Description</&>:</td>
    <td class=value colspan=2>
      <& /RTIR/Elements/EditRTIRField, 
	QueueObj => $q,
        Name => 'Description' &>
    </td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Make Constituency</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q, 
	 Name => 'Constituency' &>
    </td>
  </tr>
  <tr>
    <td class=label>
      <%loc("Make Function")%>:
    </td>
    <td class=value colspan=2>
      <& /RTIR/Elements/EditRTIRField, 
	QueueObj => $q,
        Name => 'Function' &>
    </td>
  </tr>
  <tr>
    <td class=label>
      <%loc("Make Classification")%>:
    </td>
    <td class=value colspan=2>
      <& /RTIR/Elements/EditRTIRField, 
	QueueObj => $q,
        Name => 'Classification' &>
    </td>
  </tr>
% }
</table>
</TD>
<TD VALIGN=TOP>
<table>
<tr><td class=label> <&|/l&>Make subject</&>: </td>
<td class=value> <INPUT Name="Subject" SIZE=20> </td></tr>
% if ($Type eq 'Report') {
  <tr>
    <td class="label"><&|/l&>Make SLA</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q, 
	 Name => 'SLA' &>
    </td>
  </tr>
  <tr>
    <td class=label>
      <%loc("Make How Reported")%>:
    </td>
    <td class=value colspan=2>
      <& /RTIR/Elements/EditRTIRField, 
	      QueueObj => $q,
              Name => 'HowReported' &>
    </td>
  </tr>
  <tr>
    <td class=label>
      <%loc("Make Reporter Type")%>:
    </td>
    <td class=value colspan=2>
      <& /RTIR/Elements/EditRTIRField, 
	QueueObj => $q,
        Name => 'ReporterType' &>
    </td>
  </tr>
% } elsif ($Type eq 'Block') {
  <tr>
    <td class="label"><&|/l&>Make IP Address</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q,
	 Name => 'IP' &>
    </td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Make Netmask</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q, 
	 Name => 'Netmask' &>
    </td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Make Port</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q, 
	 Name => 'Port' &>
    </td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Make Where Blocked</&>:</td>
    <td class="value">
      <& /RTIR/Elements/EditRTIRField, 
         QueueObj => $q, 
	 Name => 'WhereBlocked' &>
    </td>
  </tr>
% }

<tr><td class=label> <&|/l&>Make priority</&>: </td>
<td class=value> <INPUT Name="Priority" SIZE=4> </td></tr>
<tr><td class=label> <&|/l&>Make date Starts</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Starts_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Told</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Told_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Due</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Due_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Resolved</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Resolved_Date", ShowTime => 0, Default => '' &> </td></tr>
</table>

</TD>
</TR>
</table>
<& /Elements/TitleBoxEnd&>
<& /Elements/TitleBoxStart, title => loc('Add comments or replies to selected '.$TypeString) &>
<table>
<tr><td align=right><&|/l&>Update Type</&>:</td>
<td><select name="UpdateType">
  <option value="private" ><&|/l&>Comments (not sent to requestors)</&></option>
<option value="response" ><&|/l&>Response to requestors</&></option>
</select> 
</td></tr>
<tr><td align=right><&|/l&>Subject</&>:</td><td> <input name="UpdateSubject" size=60 value=""></td></tr>
 <tr><td align=right><&|/l&>Attach</&>:</td><td><input name="UpdateAttachment" type="file"></td></tr>
 <tr><td class=labeltop><&|/l&>Message</&>:</td><td>
 <& /Elements/MessageBox, Name=>"UpdateContent"&>
 </td></tr>
 </table>
<& /Elements/TitleBoxEnd &>

<& /Elements/Submit &>


</FORM>
<%INIT>

my ($TypeString, $Title);
if ($Type eq "Incident") {
  $TypeString = "Incidents";
  $Title = "Bulk Incident Update";
} elsif ($Type eq "Report") {
  $TypeString = "Incident Reports";
  $Title = "Bulk Incident Report Update";
} elsif ($Type eq "Investigation") {
  $TypeString = "Investigations";
  $Title = "Bulk Investigation Update";
} elsif ($Type eq "Block") {
  $TypeString = "Blocks";
  $Title = "Bulk Block Update";
}
my $q = new RT::Queue($session{'CurrentUser'});
$q->Load($TypeString);

# Iterate through the ARGS hash and remove anything with a null value.
map ($ARGS{$_} =~ /^$/ && (delete $ARGS{$_}), keys %ARGS);

my ($bgcolor, @results);
my @cols = qw(id State Subject OwnerObj->Name DueAsString );

Abort(loc("No search to operate on.")) unless ($session{'tickets'});


my $do_comment_reply=0;
# Prepare for ticket updates
$ARGS{'UpdateContent'} =~ s/\r\n/\n/g;
chomp ($ARGS{'UpdateContent'}) ;

if ($ARGS{'UpdateContent'} &&
    $ARGS{'UpdateContent'} ne '' &&
    $ARGS{'UpdateContent'} ne  "-- \n" .
    $session{'CurrentUser'}->UserObj->Signature) {
            $do_comment_reply=1;
}

#Iterate through each ticket we've been handed
my @linkresults;

while (my $Ticket = $session{'tickets'}->Next) {
    $RT::Logger->debug( "Checking Ticket ".$Ticket->Id ."\n");
    next unless ($ARGS{"UpdateTicket".$Ticket->Id});
    $RT::Logger->debug ("Matched\n");
    $ARGS{'id'} = $Ticket->Id;
    #Update the basics.
    my ($oldstate, $newstate);
    foreach my $arg (keys %ARGS) {
      if ( $arg =~ /^CustomField-(\d+)-Values$/ && defined $ARGS{$arg} ) {
        $ARGS{'Ticket-'.$Ticket->Id.'-'.$arg} = $ARGS{$arg};
        $ARGS{'Ticket-'.$Ticket->Id.'-'.$arg.'-Magic'} = $ARGS{$arg.'-Magic'};
      }
    }
    $oldstate = $Ticket->FirstCustomFieldValue('_RTIR_State');
    my @basicresults = ProcessTicketBasics(TicketObj => $Ticket, ARGSRef => \%ARGS);
    my @cfresults = ProcessTicketCustomFieldUpdates(ARGSRef => \%ARGS);
    my @dateresults = ProcessTicketDates(TicketObj => $Ticket, ARGSRef => \%ARGS);
    #Update the watchers
    my @watchresults = ProcessTicketWatchers(TicketObj => $Ticket, ARGSRef => \%ARGS);    
    
    my @updateresults; 
    if ($do_comment_reply) {
      ProcessUpdateMessage(TicketObj => $Ticket, ARGSRef => \%ARGS, Actions => \@updateresults); 
    } 
    my @tempresults = (@watchresults, @basicresults, @cfresults, @dateresults, @updateresults, @linkresults);
    $newstate = $Ticket->FirstCustomFieldValue('_RTIR_State');
    if ($newstate ne $oldstate) {
      push (@tempresults, loc("State changed from [_1] to [_2]", $oldstate, $newstate));
    }
    @tempresults = map { loc("Ticket [_1]: [_2]",$Ticket->Id,$_) } @tempresults;

    @results = (@results, @tempresults);

    foreach my $arg (keys %ARGS) {
	if ( $arg =~ /^Ticket-(\d+)-CustomField-(\d+)-/ ) {
	    delete $ARGS{$arg};
	}
    }

}

</%INIT>

<%ARGS>
$Type => undef
</%ARGS>
