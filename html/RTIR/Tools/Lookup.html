%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $title &>
<& /RTIR/Tools/Elements/Tabs, 
    current_toptab => 'RTIR/Tools/Lookup.html', 
    current_tab => 'RTIR/Tools/Lookup.html?NewSearch=1', 
    current_subtab => $current_subtab, 
    Title => $title &>

% if ($ticket) {
<& /Elements/TitleBoxStart, title => loc("Current [_1]: #[_2]", $TicketType, $ticket), color=> "#993333" &>

<TABLE WIDTH=100% border=0 cellpadding=2 CELLSPACING=0>
<& /Elements/TicketList, 
    SingleRecord => $TicketObj,
    Format => $Format,
    &>
</table>
<& /Elements/TitleBoxEnd &>
<hr>
% }

% unless ( $ARGS{'HideResults'}) {
<TABLE WIDTH=100% border=0 cellpadding=2 CELLSPACING=0>
<tr><td valign=top width=50%>

<& /Elements/TitleBoxStart, 
    title => loc('Incidents: [_1]', $q) &>
<& /RTIR/Elements/IncidentSummary, 
    Type => $TicketType, 
    ticket => $ticket, 
    q => $q &>
<& /Elements/TitleBoxEnd &>

<br>

<& /Elements/TitleBoxStart, 
    title => loc('Incident Reports: [_1]', $q), 
    color=> "#336633"&>
<& /RTIR/Elements/ChildSummary, 
    Queue => 'Incident Reports', 
    Type => $TicketType, 
    ticket => $ticket, 
    lookuptype => $type, 
    q => $q &>
<& /Elements/TitleBoxEnd&>

</td><td width=50% valign=top>

<& /Elements/TitleBoxStart, 
    title => loc('Investigations: [_1]', $q), 
    color=> "#336633" &>
<& /RTIR/Elements/ChildSummary, 
    Queue => 'Investigations', 
    Type => $TicketType, 
    ticket => $ticket, 
    lookuptype => $type, 
    q => $q &>
<& /Elements/TitleBoxEnd &>

<br>

<& /Elements/TitleBoxStart, 
    title => loc('Blocks: [_1]', $q), 
    color=> "#336633" &>
<& /RTIR/Elements/ChildSummary, 
    Queue => 'Blocks', 
    Type => $TicketType, 
    ticket => $ticket, 
    lookuptype => $type, 
    q => $q &>
<& /Elements/TitleBoxEnd &>
</TABLE>
% }

<hr>

<h2>Look Up Information</h2>
<table>
<form action="Lookup.html" method="get">
<input type=hidden name="ticket" value=<%$ARGS{'ticket'}%>>
  <tr>
    <td class=label>WHOIS:</td>
    <td class=input>
      <input size=30 name="q" value="<%$q%>"> at 
      <select name="server">
% foreach my $s (sort keys %{$servers}) {
% my ($host, $name);
% my $srv = $servers->{$s};
% next unless $srv;
% if (ref($srv) eq 'HASH') {
% $host = $srv->{'Host'};
% $name = $srv->{'FriendlyName'};
% } else {
% $host = $srv;
% }
% next unless $srv;
% my $selected = "";
% if ($servers->{$s} eq $server) {
%   $selected = " SELECTED";
% }
        <option value="<%$host%>"<%$selected%>><%$name || $host%></option>
% }
      </select>
    </td>
    <td align=left><input type=submit value="Go"></td>
  </tr>
</form>

<form action="Traceroute.html" method="get" target="_blank">
  <tr>
    <td class=label>Traceroute to:</td>
    <td class=input><input size=30 name="q" value="<%$q%>"></td>
    <td align=left><input type=submit value="Go"></td>
  </tr>
</form>
</table>

<hr>

% if ($q) {
<h2>WHOIS Results</h2>
% }
% if ($error){
<b><%$error%></b>
% }
% if ($iterator) {
%   while (my $obj = $iterator->next) {
%     my @lines_starting_with_space = grep ( /^(\s+)(\w+)/, $obj->content());
%     if ($handparse || $#lines_starting_with_space >= 4) { #we couldn't parse that. suck
%       my $content = join("", $obj->content());
%       $m->comp( '/RTIR/Elements/MakeClicky', ticket => $TicketObj, url_params => "ticket=".$ticket."&server=$server", content => \$content);
<pre><%$content|n%></pre>
<br>
%     } else {
Structured RIPE whois data returned. Click <a
href="Lookup.html?q=<%$q%>&server=<%$server%>&handparse=1">here</a> to manually
parse this data.
<BR>Warnings <%$obj->warnings%>
<BR>errors <%$obj->errors%>
<hr>
%               foreach my $attribute ($obj->attributes()) {
%                       foreach  my $value ($obj->$attribute()) {
                               <b><%$attribute%></b>: 
% $m->comp( '/RTIR/Elements/MakeClicky', ticket => $TicketObj, url_params => "ticket=".$ticket, content => \$value);
<%$value|n%><br>
%                       }
% }
% }
% }
% }

<%init>
my $current_subtab;
my $TicketType;
my $TicketObj;
#  {{{ Set up the whois query
foreach my $s (sort keys %$servers) {
  # just pick the first one
  $server = $servers->{$s} unless ($server);
  last;
}

$beauty = ( exists($beauties->{ ({ reverse %$servers }->{$server}) })
      ? $beauties->{ ({ reverse %$servers }->{$server}) } ." (". $server .")"
      : $server );

my $title = loc("Lookup '[_1]' using server [_2]", $q, $server);

use Net::Whois::RIPE;
my ($whois, $port) = split(/\s*:\s*/, $server, 2);
$port = 43 unless($port =~ /^\d+$/);
my $query = Net::Whois::RIPE->new($whois, Port => $port);
my ($iterator, $error);
if ($query) {
    $iterator = $query->query_iterator($q);
} else {
    $error = loc( "Unable to connect to WHOIS server '[_1]'", $server);
}

# }}}

    my $max_age; 
    if ($RT::RTIR_OldestRelatedTickets) {
        $max_age = 0 - $RT::RTIR_OldestRelatedTickets;
    } else {
        $max_age = -60;
    }

    my $now = RT::Date->new($session{'CurrentUser'});
    $now->SetToNow();
    $now->AddDays($max_age);

    # Init a new search
    $session{'tickets'} = RT::Tickets->new( $session{'CurrentUser'} );

if ($q) {
  $current_subtab = 'RTIR/Tools/Lookup.html?q='.$q."&server=".$server; 
    my ( $val, $msg ) =
      $session{'tickets'}->FromSQL(
            "(     ContentType = 'text/plain' "
          . "OR ContentType = 'text' "
          . "OR ContentType = 'text/html' )"
          . " AND Content LIKE '$q' "
          . " AND TransactionDate > '"
          . $now->ISO
          . "'" );

}
				   
if ($ticket) {
  ($TicketType, undef) = $m->comp("/RTIR/Elements/Type", Ticket => $ticket);
  $TicketObj = LoadTicket($ticket);
}

my $Format = $RT::RTIRSearchResultFormats->{$TicketType . 'Default'};

</%init>
<%args>
$servers => $RT::whois
$server => undef
$beauties => $RT::WhoisNames
$beauty => undef
$handparse => 1
$q => undef
$type => undef
$ticket => undef
</%args>
