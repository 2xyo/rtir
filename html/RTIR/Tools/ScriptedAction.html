%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $Title &>
<& /RTIR/Tools/Elements/Tabs, 
    current_toptab => "RTIR/Tools/ScriptedAction.html", 
    current_tab => $current_tab, 
    current_subtab => $current_subtab, 
    Title => $Title &>

<& /RTIR/Elements/ListActions, actions => \@finalresults &>

<FORM METHOD="GET" NAME="TicketUpdate" ENCTYPE="multipart/form-data">
<input type=hidden Name="WatcherTypeEmail1" value="Requestor">
<input type=hidden name="UpdateType" value="response">
<input type=hidden name="Action" value="Respond">
<input type=hidden name="Owner" value=<%$session{'CurrentUser'}->Id%>>

<INPUT TYPE=HIDDEN NAME=id Value="new">
<INPUT TYPE=HIDDEN NAME=Status Value="<%$ARGS{Status}||'open'%>">
<A NAME="top">
	
<& /Elements/TitleBoxStart, contentbg => "#cccccc", title => $Title &>
<TABLE border=0 cellpadding=0 cellspacing=2>
  <TR>
    <TD class=label>
      <&|/l&>Owner</&>:
    </TD>
    <TD>
      <%$session{'CurrentUser'}->Name%>
    </TD>
  </TR>
  <TR>
    <TD class=labeltop>
      <&|/l&>Addresses</&>:<br><small>arg: <i>_ADDR_</i></small>
    </TD>
    <TD COLSPAN=5>
% if (exists $ARGS{Addresses}) {
      <& /Elements/MessageBox, Name=>"Addresses", Width => 30, Default=>$ARGS{Addresses}, %ARGS&>
% } else {
      <& /Elements/MessageBox, Name=> 'Addresses', Width => 30 &>
% }
    </TD>
  </TR>
<TR>
  <TD class=label>
    <&|/l&>Template</&>:
  </TD>
  <TD>
    <& /Admin/Elements/SelectTemplate, Name => "Template", Default => $ARGS{'Template'}, Queue => $investigationq->Id &>
  </TD>
</TR>
<TR>
  <TD class=label>
    <&|/l&>Argument</&>:
  </TD>
  <TD>
    <INPUT Name="TemplateArg" SIZE=60 value="<% $ARGS{'TemplateArg'} %>">
  </TD>
</TR>
  <TR>
    <TD ALIGN=RIGHT COLSPAN=2>
    </TD>
  </TR>
  <TR><TD colspan=2><hr></TD></TR>

<& /RTIR/Incident/Elements/Create, Title => $Title, QueueObj => $incidentq, %ARGS &>

<TR>
  <TD class=labeltop>
    <&|/l&>Message</&>:
  </TD>
  <TD COLSPAN=5>
% if (exists $ARGS{UpdateContent}) {
<& /Elements/MessageBox, Name=>"UpdateContent", Default=>$ARGS{UpdateContent}, %ARGS&>
% } else {
<& /Elements/MessageBox, Name=>"UpdateContent", %ARGS &>
% }
  </TD>
</TR>
</TABLE>
<& /Elements/TitleBoxEnd &>
<& /Elements/Submit, Label => loc("Create")&>
</FORM>

<%INIT>
my @addrs;
my ($Incident, $Ticket);
my (@IncidentActions, @InvestigationActions, @finalresults);  

# Load the Incidents Queue
my $incidentq = new RT::Queue($session{'CurrentUser'});	
unless ($incidentq->Load('Incidents')) {
  Abort('Queue not found');
}

# Load the Investigationss Queue
my $investigationq = new RT::Queue($session{'CurrentUser'});	
unless ($investigationq->Load('Investigations')) {
  Abort('Queue not found');
}

my $addresses = $ARGS{'Addresses'};
# replace \r\n with \n
$addresses =~ s/\r\n/\n/g;
# trim blanks from ends
$addresses =~ s/^\s+//;
$addresses =~ s/\s+$//;
# replace newlines with commas (for use with parse_csv)
$addresses =~ s/\n/,/g;
@addrs = parse_csv($addresses);
    
foreach my $addr (@addrs) {
  if ((!exists $ARGS{'AddMoreAttach'}) && 
      ($ARGS{'id'} eq 'new')) { # new ticket?
    # {{{ Create a new ticket
    
# {{{ deal with deleting uploaded attachments
foreach my $key (keys %ARGS) {
    if ($key =~ m/^DeleteAttach-(.+)$/) {
	delete $session{'Attachments'}{$1};
    }
    $session{'Attachments'} = { %{$session{'Attachments'} || {}} };
}

# {{{ store the uploaded attachment in session
if ($ARGS{'Attach'}) {			# attachment?
    $session{'Attachments'} = {} unless defined $session{'Attachments'};

    # strip leading directories
    $ARGS{'Attach'} =~ s#^.*[\\/]##;


    my $attachment = MakeMIMEEntity(
        Subject             => "$ARGS{'Attach'}",
        Body                => "",
        AttachmentFieldName => 'Attach'
    );
    $session{'Attachments'} = { %{$session{'Attachments'} || {}},
				$ARGS{'Attach'} => $attachment };
}
# }}}

# delete temporary storage entry to make WebUI clean
unless (keys %{$session{'Attachments'}} and $ARGS{'id'} eq 'new') {
    delete $session{'Attachments'};
}


# }}}

    # create the Incident
    unless ($incidentq->CurrentUserHasRight('CreateTicket')) {
	Abort('You have no permission to create tickets in that queue.');
    }
    $ARGS{'Queue'} = $incidentq->Id;
    $ARGS{'Content'} = $ARGS{'UpdateContent'};

    ($Incident, @IncidentActions) =
       CreateTicket(Attachments => $session{'Attachments'}, %ARGS);
    unless ($Incident->CurrentUserHasRight('ShowTicket')) {
      Abort("No permission to view newly created ticket #".$Incident->id.".");
    }
    # }}}

    # create the linked investigation
    unless ($investigationq->CurrentUserHasRight('CreateTicket')) {
	Abort('You have no permission to create tickets in that queue.');
    }
    $ARGS{'new-MemberOf'} = $Incident->Id;
    $ARGS{'Queue'} = $investigationq->Id;
    $ARGS{'Content'} = "";
    # Create the investigation without attachments, and send them later
    ($Ticket, @InvestigationActions) =
       CreateTicket(%ARGS);
    unless ($Ticket->CurrentUserHasRight('ShowTicket')) {
      Abort("No permission to view newly created ticket #".$Ticket->id.".");
    }

    # add the address as a Requestor and update the watchers
    $ARGS{"WatcherAddressEmail1"} = $addr;
    my @watchresults;
    push @watchresults, ProcessTicketWatchers(TicketObj => $Ticket, ARGSRef => \%ARGS);    

    # find the Create transaction, so we can pass it to the template
    my $transaction;
    while ($transaction = $Ticket->Transactions->Next) {
	last if ($transaction->Type eq 'Create');
    }

    # if the template's argument contains _ADDR_, substitute the address
    my $arg = $ARGS{'TemplateArg'};
    $arg =~ s/_ADDR_/$addr/g;

    # load the selected template
    my $TemplateObj = new RT::Template($session{'CurrentUser'});
    $TemplateObj->Load($ARGS{'Template'});
    my ( $result, $message ) = $TemplateObj->Parse(
                                         Argument       => $arg,
                                         TicketObj      => $Ticket,
					 TransactionObj => $transaction,
    );


    # add the template's MIMEObj to the Attachments list
    $session{'Attachments'} = { _Body => $TemplateObj->MIMEObj,
				%{$session{'Attachments'} || {}} };

    # the content will be part of the template, if desired
    $ARGS{'UpdateContent'} = " ";
    $ARGS{UpdateAttachments} = $session{'Attachments'};
    my @updateresults; 
    ProcessUpdateMessage(ARGSRef=>\%ARGS, 
			 Actions=>\@updateresults, 
			 TicketObj=>$Ticket);

    # say what ticket these refer to
    my @tempresults = (@watchresults, @updateresults);
    @tempresults = map { loc("Ticket [_1]: [_2]",$Ticket->Id,$_) } @tempresults;

    # put all the results together
    push (@finalresults, @IncidentActions, @InvestigationActions, @tempresults);

    # delete attachments only after they've been sent to everyone
    delete $session{'Attachments'};

  }
}

sub parse_csv {
    my $text = shift;      # record containing comma-separated values
    my @new  = ();
    push(@new, $+) while $text =~ m{
        # the first part groups the phrase inside the quotes.
        # see explanation of this pattern in MRE
        "([^\"\\]*(?:\\.[^\"\\]*)*)",?
           |  ([^,]+),?
           | ,
       }gx;
       push(@new, undef) if substr($text, -1,1) eq ',';
       return @new;      # list of values that were comma-separated
}


</%INIT>

<%ARGS>
$Title => loc("Scripted Action: Create Incidents and Investigations")
$current_tab => "RTIR/Tools/ScriptedAction.html"; 
$current_subtab => undef
</%ARGS>
