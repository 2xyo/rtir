<table width="100%" border="0" cellpadding="2" cellspacing="0">
<tr><td valign="top" width="50%">

<&| /Widgets/TitleBox, title => loc('Incidents: [_1]', $q), class => 'tickets-list-incident' &>
<& /RTIR/Elements/IncidentSummary, 
    ticket     => $TicketObj->id, 
    lookuptype => $LookupType, 
    q          => $q,
&>
</&>

</td><td valign="top" width="50%">

<&| /Widgets/TitleBox, title => loc('Investigations: [_1]', $q), class => 'tickets-list-investigation' &>
<& /RTIR/Elements/ChildSummary, 
    Queue      => 'Investigations', 
    ticket     => $TicketObj->id, 
    lookuptype => $LookupType, 
    q          => $q,
&>
</&>

</td></tr><tr><td valign="top" width="50%">

<&| /Widgets/TitleBox, title => loc('Incident Reports: [_1]', $q), class => 'tickets-list-report' &>
<& /RTIR/Elements/ChildSummary,
    Queue      => 'Incident Reports',
    ticket     => $TicketObj->id,
    lookuptype => $LookupType,
    q          => $q,
&>
</&>

</td><td width="50%" valign="top">

% unless ( RT->Config->Get('RTIR_DisableBlocksQueue') ) {
<&| /Widgets/TitleBox, title => loc('Blocks: [_1]', $q), class => 'tickets-list-block' &>
<& /RTIR/Elements/ChildSummary,
    Queue      => 'Blocks',
    ticket     => $TicketObj->id,
    lookuptype => $LookupType,
    q          => $q,
&>
</&>
</td></tr>

</table>
% }
<%args>
$TicketObj
$LookupType => undef
$q => undef
</%args>
<%init>
my $max_age = -60;

if ( my $tmp = RT->Config->Get('RTIR_OldestRelatedTickets') ) {
    $max_age = 0 - $tmp;
}

my $now = RT::Date->new( $session{'CurrentUser'} );
$now->SetToNow;
$now->AddDays( $max_age );

$session{'tickets'} = RT::Tickets->new( $session{'CurrentUser'} );

if ( $q ) {
    my $query;
    if ( $type && RT::IR->CustomFields( Field => $type ) ) {
        $query = "'CF.{$type}' = '$q'"
    } else {
        $query = "( ContentType = 'text/plain' OR ContentType = 'text' OR ContentType = 'text/html' )"
        . " AND Content LIKE '$q'";

        # apply transaction date search only if it's FTS as otherwise
        # it can ruin performance of mysql optimizer rather than help
        $query = "( $query ) AND TransactionDate > '". $now->ISO ."'"
    }

    my ($val, $msg) = $session{'tickets'}->FromSQL( $query );
    $RT::Logger->warning( $msg ) unless $val;
}
</%init>
