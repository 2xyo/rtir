%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $Title &>
<& /RTIR/Incident/Elements/Tabs, 
    current_tab => $current_tab, 
    current_subtab => $current_subtab, 
    Title => $Title,
    Ticket => $TicketObj &>

<& /Elements/ListActions, actions => \@results &>

<%PERL>
if ( $link && !$link->CurrentUserHasRight('ModifyTicket') ) {
    $m->out( loc('You are not allowed to edit this Incident.') );
    $m->abort();
}
</%PERL>

<form action="Create.html" method="POST" enctype="multipart/form-data">

<input type="hidden" name="id" value="new" />
<input type="hidden" name="Queue" value="<% $QueueObj->Name %>" />
<input type="hidden" name="Status" value="<% $ARGS{'Status'} || 'open' %>" />
<input type="hidden" name="child" value="<% $ARGS{'child'} %>" />
<input type="hidden" name="new-MemberOf" value="<% $ARGS{'new-MemberOf'} %>" />
<input type="hidden" name="MemberOf-new" value="<% $ARGS{'MemberOf-new'} %>" />
<A name="top">

<&| /Widgets/TitleBox, title => $Title &>
<table border="0" cellpadding="0" cellspacing="2">

% if ($link) {
% my ($Type) = $m->comp("/RTIR/Elements/Type", TicketObj => $link );
<tr><td class="label"><% $label %>:</td>
<td><% loc("[_1] #[_2]: [_3]", $Type, $link->Id, $link->Subject) %></td></tr>
% }

<tr>
% if ($ChildObj) {
    <td class="label"><&|/l&>Owner</&>:</td>
    <td class="value"><% $ChildObj->OwnerObj->Name %></td>
    <input type="hidden" name="Owner" value=<% $ChildObj->Owner %> />
% } else {
    <td class="label"><&|/l&>Owner</&>:</td>
    <td>
      <& /Elements/SelectOwner, 
          Name     => 'Owner',
          QueueObj => $QueueObj,
          Default  => $ARGS{Owner} || $session{'CurrentUser'}->Id
      &>
    </td>
% }
</tr>

<& Elements/Create, Title => $Title, TicketObj => $TicketObj, QueueObj => $QueueObj, %ARGS &>

<tr><td class=labeltop><&|/l&>Message</&>:</td>
<td>
<%PERL>
unless ( exists $ARGS{Content} ) {
    my $Transactions;
    if ($TicketObj) {
        $Transactions = $TicketObj->Transactions;
    } elsif ( $ChildObj ) {
        $Transactions = $ChildObj->Transactions;
    }
    if ( $Transactions ) {
        $ARGS{Content} = $m->scomp("/RTIR/Elements/TransactionData", 
            Transactions => $Transactions,
            Type => 'messages',
            Include => {'Create', 'Correspond'}
         );
         $ARGS{Content} =~ s/\&gt;/>/g;
    }
}
</%PERL>
<& /Elements/MessageBox, Default => $ARGS{Content} &>
</td></tr>
</table>

<table border="0" cellpadding="0" cellspacing="2">
<tr><td width="50%" valign="top">

<&| /Widgets/TitleBox,
    title => loc('The Basics'),
    title_class => 'inverse',
    color => "#993333",
&>
<table border="0">
    <tr><td align="right"><&|/l&>Priority</&>:</td>
    <td><input size=3 name="InitialPriority" value="<% $ARGS{InitialPriority} || $QueueObj->InitialPriority %>"></td></tr>

    <tr><td align="right"><&|/l&>Final Priority</&>:</td>
    <td><input size=3 name="FinalPriority" value="<% $ARGS{FinalPriority} || $QueueObj->FinalPriority %>"></td></tr>

    <tr><td align="right"><&|/l&>Time Worked</&>:</td>
    <td><input size=3 name="TimeWorked" value="<% $ARGS{TimeWorked} || '0' %>"></td></tr>

    <tr><td align="right"><&|/l&>Time Left</&>:</td>
    <td><input size=3 name="TimeLeft" value="<% $ARGS{TimeLeft} || '0' %>"></td></tr>
</table>
</&>

</td><td valign="top">

<&| /Widgets/TitleBox,
    title => loc("Dates"),
    title_class=> 'inverse',  
    color => "#663366",
&>
<table border="0">

    <tr><td align="right"><&|/l&>Starts</&>:</td>
    <td><input size=10 name="Starts" value="<% $ARGS{'Starts'} || '' %>"></td></tr>
    
    <tr><td align="right"><&|/l&>Due</&>:</td>
	<td><input size=10 name="Due" value="<% $ARGS{'Due'} || '' %>"></td></tr>

</table>
</&>

</td></tr>
</table>

</&>

<& /Elements/Submit, Label => loc("Create") &>
</form>


<%INIT>
# if there isn't a subject, but there is a child, use that one
my $ChildObj;

if ( !$ARGS{'Subject'} && $child ) {
    $ChildObj = LoadTicket( $child );
    $ARGS{'Subject'} = $ChildObj->Subject;
}

my ($link, $label);
if ($ARGS{'new-MemberOf'}) {
    $link = LoadTicket($ARGS{'new-MemberOf'});
    $label = loc("Split from");
} elsif ($ARGS{'MemberOf-new'}) {
    $link = LoadTicket($ARGS{'MemberOf-new'});
    $label = loc("Link with");
} elsif ($child) {
    $link = LoadTicket($child);
    $label = loc("Link with");
}

my $QueueObj = new RT::Queue( $session{'CurrentUser'} );
$QueueObj->Load( 'Incidents' ) || Abort( loc("Queue could not be loaded.") );

my $TicketObj = $ARGS{TicketObj};

# {{{ deal with deleting uploaded attachments
foreach my $key (keys %ARGS) {
    if ($key =~ m/^DeleteAttach-(.+)$/) {
        delete $session{'Attachments'}{$1};
    }
    $session{'i'}++;
}

# {{{ store the uploaded attachment in session
if ( $ARGS{'Attach'} ) { # attachment?
    $session{'Attachments'} ||= {};

    # strip leading directories
    $ARGS{'Attach'} =~ s#^.*[\\/]##;

    my $attachment = MakeMIMEEntity(
        Subject             => "$ARGS{'Attach'}",
        Body                => "",
        AttachmentFieldName => 'Attach'
    );
    $session{'Attachments'}->{ $ARGS{'Attach'} } = $attachment;
    $session{'i'}++;
}
# }}}

# delete temporary storage entry to make WebUI clean
unless ( keys %{ $session{'Attachments'} } && $ARGS{'id'} eq 'new' ) {
    delete $session{'Attachments'};
}

# }}}

my @results;
if ( !exists $ARGS{'AddMoreAttach'} && $ARGS{'id'} eq 'new' ) { # new ticket?
    $m->comp('Display.html', %ARGS);
    return;
}
</%INIT>

<%ARGS>
$QuoteTransaction => undef
$Title            => loc("Create a new Incident")
$current_tab      => "RTIR/Create.html?Queue=Incidents"
$current_subtab   => "RTIR/Create.html?Queue=Incidents"
$child            => undef
</%ARGS>
