%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $Title &>
<& /RTIR/Incident/Elements/Tabs, 
    current_tab => $current_tab, 
    current_subtab => $current_subtab, 
    Title => $Title,
    Ticket => $TicketObj &>

<& /Elements/ListActions, actions => \@results &>

% if ($link &&
%      !$link->CurrentUserHasRight('ModifyTicket')) {
<&|/l&>You are not allowed to edit this Incident.</&>
%    $m->abort();
% }

<FORM action="Create.html" METHOD="POST" ENCTYPE="multipart/form-data">

<INPUT TYPE=HIDDEN Name="id" VALUE="new">
<INPUT TYPE=HIDDEN NAME=Queue Value="<%$QueueObj->Name%>">
<INPUT TYPE=HIDDEN NAME=Status Value="<%$ARGS{Status}||'open'%>">
<INPUT TYPE=HIDDEN NAME=child Value="<%$ARGS{child}%>">
<input type=hidden name="new-MemberOf"<% $ARGS{'new-MemberOf'} && " VALUE=$ARGS{'new-MemberOf'}" %>>
<input type=hidden name="MemberOf-new"<% $ARGS{'MemberOf-new'} && " VALUE=$ARGS{'MemberOf-new'}" %>>
<A NAME="top">
	
<& /Widgets/TitleBoxStart, contentbg => "#cccccc", title => $Title &>
<TABLE border=0 cellpadding=0 cellspacing=2>
% if ($link) {
%   my ($Type, undef) = $m->comp("/RTIR/Elements/Type", Ticket => $link->Id);
%   $Type =~ s/\s*$//;
  <TR>
    <TD class="label"><%$label%>:</TD>
    <TD><% loc("[_1] #[_2]: [_3]", $Type, $link->Id, $link->Subject) %></TD>
  </TR>
% }

  <TR>
% if ($ChildObj) {
    <td class="label"><&|/l&>Owner</&>:</td>
    <td class="value"><%$ChildObj->OwnerObj->Name%></td>
    <input type=hidden name="Owner" value=<%$ChildObj->Owner%>>
% } else {
    <TD class=label>
      <&|/l&>Owner</&>:
    </TD>
    <TD>
      <& /Elements/SelectOwner, 
          Name => "Owner", 
	  QueueObj => $QueueObj, 
	  Default => $ARGS{Owner}||$session{'CurrentUser'}->Id||undef &>
    </TD>
% }
  </TR>

<& Elements/Create, Title => $Title, TicketObj => $TicketObj, QueueObj => $QueueObj, %ARGS &>

<TR>
<TD class=labeltop>
<&|/l&>Message</&>:
</TD>
<TD COLSPAN=5>
% if (!exists $ARGS{Content}) {
%   my $Transactions;
%   if ($TicketObj) {
%   $Transactions = $TicketObj->Transactions;
%   } elsif ($ChildObj) {
%   $Transactions = $ChildObj->Transactions;
%   }
%   if ($Transactions) {
%     $ARGS{Content} = $m->scomp("/RTIR/Elements/TransactionData", 
%        Transactions => $Transactions,
%        Type => 'messages',
%        Include => {'Create', 'Correspond'});
%     $ARGS{Content} =~ s/\&gt;/>/g;
%   }
% }
<& /Elements/MessageBox, Default => $ARGS{Content} &>
  <BR>
  </TD>
</TR>
<TR>
  <TD ALIGN=RIGHT COLSPAN=2>
  </TD>
</TR>
<TR>
  <TD>
  </TD>
  <TD WIDTH="50%" VALIGN=TOP>
    <& /Widgets/TitleBoxStart, title => loc('The Basics'), 
	title_class=> 'inverse',  
	color => "#993333" &>
    <TABLE BORDER=0>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Priority</&>:</TD>
	<TD><input size=3 name="InitialPriority" value="<% $ARGS{InitialPriority} ? $ARGS{InitialPriority} : $QueueObj->InitialPriority %>"></TD>
      </TR>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Final Priority</&>:</TD>
	<TD><input size=3 name="FinalPriority" value="<% $ARGS{FinalPriority} ? $ARGS{FinalPriority} : $QueueObj->FinalPriority %>"></TD>
      </TR>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Time Worked</&>:</TD>
	<TD><input size=3 name="TimeWorked" value="<% $ARGS{TimeWorked} || "0" %>"></TD>
      </TR>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Time Left</&>:</TD>
	<TD><input size=3 name="TimeLeft" value="<% $ARGS{TimeLeft}||"0" %>"></TD>
      </TR>
    </TABLE>
    <& /Widgets/TitleBoxEnd &>
  </TD>

  <TD VALIGN=TOP>
    <& /Widgets/TitleBoxStart, title => loc("Dates"),
		title_class=> 'inverse',  
		 color => "#663366" &>

    <TABLE BORDER=0>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Starts</&>:</TD>
% if ($ARGS{Starts}) {
          <TD><input size=10 name="Starts" VALUE="<%$ARGS{Starts}%>"></TD>
% } else {
          <TD><input size=10 name="Starts"></TD>
% }
      </TR>
      <TR>
        <TD ALIGN=RIGHT><&|/l&>Due</&>:</TD>
	<TD><input size=10 name="Due" value="<% $ARGS{Due} %>"></TD>
      </TR>
    </TABLE>
    <& /Widgets/TitleBoxEnd &>
  </TD>
</TR>
</TABLE>
<& /Widgets/TitleBoxEnd &>

<& /Elements/Submit, Label => loc("Create")&>
</FORM>


<%INIT>
# if there isn't a subject, but there is a child, use that one
my $ChildObj;

if ((!$ARGS{'Subject'}) and $child) {
  $ChildObj = LoadTicket($child);
  $ARGS{'Subject'} = $ChildObj->Subject;
}

my ($link, $label);
if ($ARGS{'new-MemberOf'}) {
  $link = LoadTicket($ARGS{'new-MemberOf'});
  $label = loc("Split from");
} elsif ($ARGS{'MemberOf-new'}) {
  $link = LoadTicket($ARGS{'MemberOf-new'});
  $label = loc("Link with");
} elsif ($child) {
  $link = LoadTicket($child);
  $label = loc("Link with");
}

my $QueueObj = new RT::Queue($session{'CurrentUser'});
$QueueObj->Load("Incidents") || Abort(loc("Queue could not be loaded."));

my $CFs = $QueueObj->CustomFields();
my $TicketObj = $ARGS{TicketObj};

# {{{ deal with deleting uploaded attachments
foreach my $key (keys %ARGS) {
    if ($key =~ m/^DeleteAttach-(.+)$/) {
	delete $session{'Attachments'}{$1};
    }
    $session{'Attachments'} = { %{$session{'Attachments'} || {}} };
}

# {{{ store the uploaded attachment in session
if ($ARGS{'Attach'}) {			# attachment?
    $session{'Attachments'} = {} unless defined $session{'Attachments'};

     # strip leading directories
     $ARGS{'Attach'} =~ s#^.*[\\/]##;


    my $attachment = MakeMIMEEntity(
        Subject             => "$ARGS{'Attach'}",
        Body                => "",
        AttachmentFieldName => 'Attach'
    );
    $session{'Attachments'} = { %{$session{'Attachments'} || {}},
				$ARGS{'Attach'} => $attachment };
}
# }}}

# delete temporary storage entry to make WebUI clean
unless (keys %{$session{'Attachments'}} and $ARGS{'id'} eq 'new') {
    delete $session{'Attachments'};
}


# }}}

my @results;
if ((!exists $ARGS{'AddMoreAttach'}) && ($ARGS{'id'} eq 'new')) { # new ticket?
#  if ($ARGS{'Function'} and $ARGS{$ARGS{'Function'}}) {
# commented out because the implementation was not forward compatible with 3.4
    $m->comp('Display.html', %ARGS);
  return();
#  } else {
#    push @results, loc("Incident creation failed: Function must be set.");
#  }
}
</%INIT>

<%ARGS>
$QuoteTransaction => undef
$Title => loc("Create a new Incident")
$current_tab => "RTIR/Create.html?Queue=Incidents"
$current_subtab => "RTIR/Create.html?Queue=Incidents"
$child => undef
</%ARGS>
