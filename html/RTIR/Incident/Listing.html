%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Header, Title => $title, Refresh => $session{'tickets_refresh_interval'} &>
<& Elements/Tabs, 
    current_tab => 'RTIR/Incident/Listing.html', 
    Title => $title &>

<& /RTIR/Elements/Listing, Type => 'Incident', %ARGS &>

<%init>
my $title = loc("Find Incidents");

if ( $ARGS{'q'} ) {
    my $query = $ARGS{'q'};

    if ( $query =~ m/^\s*(\d+)\s*$/ ) {
        $m->redirect("$RT::WebPath/RTIR/Incident/Display.html?id=$1");
    }

    $session{'tickets'} = RT::Tickets->new( $session{'CurrentUser'} );

    if ( $query =~ m/\@/ ) {
        $session{'tickets'}->LimitRequestor( VALUE    => $query,
                                             OPERATOR => '=', );
        $m->redirect("$RT::WebPath/RTIR/Incident/Listing.html");
    }

    #
    # Any search on queue name or subject will be for new/open tickets
    # only.
    #
    $session{'tickets'}->LimitStatus( VALUE    => $_,
                                      OPERATOR => '=', ) for qw(open new);

    my $queue = RT::Queue->new( $session{'CurrentUser'} );
    if ( $queue->Load($query) && $queue->Id ) {
        $session{'tickets'}->LimitQueue( VALUE    => $queue->Id,
                                         OPERATOR => '=', );
        $m->redirect("$RT::WebPath/RTIR/Incident/Listing.html");
    }
    $session{'tickets'}->LimitSubject( VALUE    =>  $query,
                                       OPERATOR => 'LIKE' );

    $m->redirect("$RT::WebPath/RTIR/Incident/Listing.html");
}

</%init>
