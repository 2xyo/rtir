%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
% if ($TextReport) {
<&|/l, $Constituency &>RTIR Periodic Report for [_1]</&>

<&|/l&>Start date:</&> <% $rtstart->AsString %>
<&|/l&>End date:</&> <% $rtend->AsString %>

<&|/l&>Incident Report Summary (including unlinked Incident Reports)</&>
<&|/l&>Outstanding reports at the beginning of this period;</&><% scalar keys %$outstanding_pruned %>
<&|/l&>Total new reports for this period</&>;<% scalar keys %$tix_created_pruned %>
<&|/l&>Incident Reports resolved during this period</&>;<% scalar keys %$tix_resolved_pruned %>
<&|/l&>Reports unresolved at the end of the period</&>;<% scalar keys %$tix_unresolved_pruned %>

% } else {
<h1><&|/l, $Constituency &>RTIR Periodic Report for [_1]</&></h1>
<table>
  <tr>
    <td><&|/l&>Start date:</&></td>
    <td><% $rtstart->AsString %></td>
  </tr>
  <tr>
    <td><&|/l&>End date:</&></td>
    <td><% $rtend->AsString %></td>
  </tr>
</table>

<table>
<tr><th align="left" colspan="2"><&|/l&>Incident Report Summary (including unlinked Incident Reports)</&></th></tr>
<tr>
  <td><&|/l&>Outstanding reports at the beginning of this period</&></td>
  <td class="value"> <% scalar keys %$outstanding_pruned %></td>
</tr>
<tr>
  <td><&|/l&>Total new reports for this period</&></td>
  <td><% scalar keys %$tix_created_pruned %></td>
</tr>
<tr>
  <td><&|/l&>Incident Reports resolved during this period</&></td>
  <td><% scalar keys %$tix_resolved_pruned %></td>
</tr>
<tr>
  <td><&|/l&>Reports unresolved at the end of the period</&></td>
  <td><% scalar keys %$tix_unresolved_pruned %></td>
</tr>
</table>
% }
% foreach my $incident_type( @functions ) {
% if ($TextReport) {
<% $incident_type %>
% } else {
<h2><% $incident_type %></h2>
% }

% if ($TextReport) {
<&|/l&>Incident reports received</&>
% } else {
<table>
<th align="left" colspan="2"><&|/l&>Incident reports received</&></th>
% }

<%PERL>

foreach my $class (@classifications) {
    my $class_count = 0;
    $tix_created->GotoFirstItem();
    while ( my $t = $tix_created->Next ) {
        my $value = $get_incident_field->( $t, '_RTIR_Constituency');
        next if ($value ne $Constituency);

        $value = $get_incident_field->( $t, '_RTIR_Classification');
        next if ($class ne 'Unclassified' && $value ne $class);
        next if ($class eq 'Unclassified' && $value ne "");

        $value = $get_incident_field->( $t, '_RTIR_Function');
        next if	($value ne $incident_type);

        $class_count++;
    }

</%perl>
% if ($TextReport) {
<% $class %>;<% $class_count %>
% } else {
<tr>
  <td><% $class %></td>
  <td class="value"><% $class_count %></td>
</tr>
% }
% }
% if ($TextReport) {

% } else {
</table>
% }
<%PERL>
    foreach my $service_level( @sla_levels ) {
        my $class_tix = RT::Tickets->new( $session{'CurrentUser'} );
        $class_tix->FromSQL("Queue = 'Incident Reports' AND Created > '$start' AND Created < '$end' AND CustomField.{_RTIR_SLA} = '$service_level'");
        my $mytix = $filter_by_incident_field->(
            $filter_by_incident_field->(
                $class_tix,
                '_RTIR_Constituency',
                $Constituency
            ),
            '_RTIR_Function',
            $incident_type,
        );

        my $myoutstanding = $filter_by_incident_field->(
            $filter_by_incident_field->(
                $outstanding,
                '_RTIR_Constituency',
                $Constituency
            ),
            '_RTIR_Function',
            $incident_type,
        ); 
</%PERL>
% if ($TextReport) {
<% $service_level %>
% } else {
<h3><% $service_level %></h3>
% }

% if ($TextReport) {
<& Elements/SLASummaryText,
    class_tix => $mytix, outstanding => $myoutstanding, 
    service_level => $service_level,
    start => $rtstart, end => $rtend &>
% } else {
<& Elements/SLASummary,
    class_tix => $mytix, outstanding => $myoutstanding, 
    service_level => $service_level,
    start => $rtstart, end => $rtend &>
% }
<%perl>
    }
}
if ($TextReport) {
  $m->abort();
}

</%PERL>

<%INIT>

my $get_incident_field = sub {
    my $t = shift;
    my $field = shift;

    # find the parent incident
    my $query = "Queue = 'Incidents' AND HasMember = ". $t->Id;
    my $incidents = new RT::Tickets( $session{'CurrentUser'} );
    $incidents->FromSQL( $query );

    my $parent = $incidents->First;
    return undef unless $parent;
    return RT::IR::Ticket::FirstCustomFieldValue( $parent, $field );
};

my $filter_by_incident_field = sub {
    my ($tickets, $field, $condition) = (@_);
    my $res = {};
    unless ( ref $tickets eq 'HASH' ) {
        while ( my $t = $tickets->Next ) { $res->{ $t->Id } = $t }
    }
    else {
        %$res = %$tickets;
    }

    while( my($id, $t) = each %$res ) {
        my $value = $get_incident_field->( $t, $field );
        delete $res->{$id} if !$value || $value ne $condition;
    }
    return $res;
};

my $start = ParseDateToISO( $StartDate );
my $end = ParseDateToISO( $EndDate );
my $rtstart = new RT::Date($RT::SystemUser);
$rtstart->Set( Format => 'ISO', Value => $start );
my $rtend = new RT::Date($RT::SystemUser);
$rtend->Set( Format => 'ISO', Value => $end );

$Constituency = $ARGS{ 'Object-RT::Ticket--'. $Constituency } if $Constituency;

# of new reports created during the period broken down by function
my @functions;
{
    my $cf = RT::CustomField->new( $session{'CurrentUser'} );
    $cf->LoadByNameAndQueue( Queue => 'Incidents', Name => '_RTIR_Function' );
    my $values = $cf->Values;
    while ( my $value = $values->Next ) {
        push @functions, $value->Name;
    }
}

# of new reports created during the period broken down by classification
my @classifications;
{
    my $cf = RT::CustomField->new( $session{'CurrentUser'} );
    $cf->LoadByNameAndQueue( Queue => 'Incidents', Name => '_RTIR_Classification' );
    my $values = $cf->Values;
    while ( my $value = $values->Next ) {
        push @classifications, $value->Name;
    }
    push @classifications, 'Unclassified';
}

# of new reports created during the period broken down by SLA level
my @sla_levels;
{
    my $cf = RT::CustomField->new( $session{'CurrentUser'} );
    $cf->LoadByNameAndQueue( Queue => 'Incidents', Name => '_RTIR_SLA' );
    my $values = $cf->Values;
    while ( my $value = $values->Next ) {
        push @sla_levels, $value->Name;
    }
}

# of new reports outstanding at start of the period
my $outstanding = RT::Tickets->new( $session{'CurrentUser'} );
$outstanding->FromSQL("Queue = 'Incident Reports' AND Created < '$start' AND (Resolved='1970-01-01 00:00:00' OR Resolved > '$start')");
my $outstanding_pruned = $filter_by_incident_field->($outstanding, '_RTIR_Constituency', $Constituency);

# of new reports created during the period
my $tix_created = RT::Tickets->new( $session{'CurrentUser'} );
$tix_created->FromSQL("Queue = 'Incident Reports' AND Created > '$start' AND Created < '$end'");
my $tix_created_pruned = $filter_by_incident_field->($outstanding, '_RTIR_Constituency', $Constituency);

# of new reports resolved/closed/deleted during the period
# this means "number of reports created during the period that were 
# also closed during the period"

my $tix_resolved = RT::Tickets->new($session{'CurrentUser'});
$tix_resolved->FromSQL("Queue = 'Incident Reports' AND Created > '$start' AND Created < '$end' AND (Resolved > '1970-01-01 00:00:00' AND Resolved <'$end')");
my $tix_resolved_pruned = $filter_by_incident_field->($outstanding, '_RTIR_Constituency', $Constituency);

# of new reports oustanding at end of the period
# this is "number of reports created during the period that were also 
# closed during the period"

my $tix_unresolved = RT::Tickets->new( $session{'CurrentUser'} );
$tix_unresolved->FromSQL("Queue = 'Incident Reports' AND Created > '$start' AND Created < '$end' AND (Resolved='1970-01-01 00:00:00' OR Resolved>'$end')");
my $tix_unresolved_pruned = $filter_by_incident_field->($outstanding, '_RTIR_Constituency', $Constituency);

if ($TextReport) {
    $r->content_type('text/plain');
}
</%INIT>

<%ARGS>
$StartDate    => undef
$EndDate      => undef
$Constituency => undef
$HTMLReport   => 1
$TextReport   => !$HTMLReport
</%ARGS>
