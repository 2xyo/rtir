%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /RTIR/Elements/Tabs, 
	tabs => $tabs, 
	actions => $actions, 
	current_tab => $current_tab, 
	current_toptab => "RTIR/Incident/Listing.html",
	Title => $Title &> 

<%INIT>
	
  my $searchtabs = { new => { title => loc('New Search'),
                              path => '/RTIR/Incident/Listing.html?ClearRestrictions=1'}
	};

  my ($id, $tabs);
  my $actions;
  if ($Incident) {
    $id = $Incident->id();
    $tabs = {
		 D => { title => loc('Display'),
			path => "RTIR/Incident/Display.html?id=".$id,
		      },
	      
	         H => { title => loc('Edit'),
		     path => "RTIR/Incident/Edit.html?id=".$id,
		      },
	      
	         I => { title => loc('Incident Reports'),
		      path => "RTIR/Incident/History.html?id=".$id,
		      },

	         J => { title => loc('Investigations'),
		      path => "RTIR/Incident/History.html?id=".$id,
		      },
  	       };

    if ($Incident->CurrentUserHasRight('ModifyTicket')) {
      if ($Incident->Status ne 'resolved') {
	$actions->{'B'} = 
	  { 

           path => "RTIR/Incident/Update.html?Action=Comment&DefaultStatus=resolved&id=".$id,
	   title => loc('Resolve')
	  };
    }	
  }

  if ($Incident->CurrentUserHasRight('OwnIncident')) {
    if ($Incident->OwnerObj->id == $RT::Nobody->id)  {
	$actions->{'D'} = 	
	  { 
	   path => "RTIR/Incident/Display.html?Action=Take&id=".$id,
	   title => loc('Take')
	  };
    }
    elsif ( $Incident->OwnerObj->id != $session{CurrentUser}->id) {
	$actions->{'E'} = 	
	  { 
	   path => "RTIR/Incident/Display.html?Action=Steal&id=".$id,
	   title => loc('Steal') 
	  };
    }
  }

  if ($Incident->CurrentUserHasRight('ModifyIncident') or 
    $Incident->CurrentUserHasRight('CommentOnIncident')) {
    $actions->{'F'} = 
      { 
       title => loc('Comment'),
	path => "RTIR/Incident/Update.html?Action=Comment&id=".$id,
      };
    $actions->{'G'} = 
      { 
       title => loc('Close Reports'),
	path => "RTIR/Incident/Update.html?Action=Comment&id=".$id,
      };
    $actions->{'H'} = 
      { 
       title => loc('Close Investigations'),
	path => "RTIR/Incident/Update.html?Action=Comment&id=".$id,
      };
  };

  if (defined $session{'tickets'}) {
    my $items = $session{'tickets'}->ItemsArrayRef();
    my @indexs = grep(($items->[$_]->id == $Incident->Id), 0 .. $#{$items});
    if ( $items->[0] && @indexs ) {

        if ( $items->[ $indexs[0] ]->id == $Incident->Id ) {

            # Don't $current_toptab = display prev links if we're on the first ticket
            if ( $items->[0]->id != $Incident->id ) {

                $searchtabs->{'_a'} = {
                            class => "nav",
                            path => "Incident/Display.html?id=" . $items->[0]->id,
                            title => '&lt;&lt; ' . loc('First') };
                $searchtabs->{"_b"} = { class => "nav",
                                  path  => "Incident/Display.html?id="
                                    . $items->[ $indexs[0] - 1 ]->id,
                                  title => '&lt; ' . loc('Prev') };
            }
        }
    }

    if ( $items->[0] && @indexs ) {

        # Don't display next links if we're on the last ticket
        if ( $Incident->id != $items->[-1]->id ) {
            $searchtabs->{'d'} = { class => "nav",
                             path  => "Incident/Display.html?id="
                               . $items->[ $indexs[0] + 1 ]->id,
                             title => loc('Next') . ' &gt;' };
            $searchtabs->{'e'} = {
                           class => "nav",
                           path => "Incident/Display.html?id=" . $items->[-1]->id,
                           title => loc('Last') . ' &gt;&gt' };
        }
    }
  }
}
  $tabs->{"A"} = { title => loc('New Incident'),
  		     	path => "RTIR/Incident/Modify.html?Create=1",
	       };
  $tabs->{"B"} = { path      => 'RTIR/Incident/Listing.html',
                 title     => loc('Search'),
                 separator => 1,
                 subtabs   => $searchtabs };

</%INIT>

 
<%ARGS>
$Incident => undef
$current_tab => undef
$Title => undef
</%ARGS>
